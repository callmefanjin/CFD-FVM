## 隐式时间推进

### 牛顿法：

以模型方程为例：
$$
\frac{\partial U}{\partial t} + \frac{\partial F}{\partial x} = S(U)
$$
做一阶隐式离散：
$$
U^{n+1} - U^{n} = \Delta t(-\frac{\partial F(U^{n+1})}{\partial x} + S(U^{n+1}))
$$
暂时写成：
$$
U^{n+1} - U^{n} = \Delta t R(U^{n+1})
$$
隐式推进问题转化为，求解$U^{n+1}$，使得：
$$
G(U^{n+1}) = U^{n+1} - U^{n} - \Delta t R(U^{n+1}) = 0
$$
即求解$G(U^{n+1}) = 0$

随后使用牛顿法求解上面这个非线性方程，假设初始猜测值为$(U^{k},G(U^{k}))$

我们希望:
$$
G(U^{k}+\Delta U)=0
$$
展开有：
$$
G(U^{k}+\Delta U)≈G(U^{k})+G'(U^{k})\Delta U = 0
$$
则：
$$
G'(U^{k})\Delta U = -G(U^{k}) \\
J_g(U^{k})\Delta U = -G(U^{k})
$$
更新U：
$$
U^{k+1} = U^{k}+\Delta U
$$
最终直到$G(U^{i}) = 0$，即认为$U^{n+1} = U^{i}$



### 雅可比矩阵处理：

牛顿法计算中需要$J_g(U)$，做推导如下：
$$
J_g(U) = (U - U^{n} - \Delta t R(U))’ = I - \Delta t \frac{\partial{R(U)}}{\partial U}
$$
考虑到
$$
R(U) = -\frac{\partial F(U)}{\partial x} + S(U)
$$
所以隐式时间推进就落到了计算某个量关于U的雅可比矩阵$J_R(U)$，数值计算雅可比：
$$
J_R^{ij} = \frac{\partial R_i}{\partial U_j} = \frac{R_i(U+\epsilon e_j) - R_i(U)}{\epsilon}
$$

$$
J_R = \begin{bmatrix}
\frac{\partial R_1}{\partial U_1}  & \cdots & \frac{\partial R_1}{\partial U_n} \\
\vdots & \frac{\partial R_i}{\partial U_j} & \vdots  \\
\frac{\partial R_m}{\partial U_1} & \cdots & \frac{\partial R_m}{\partial U_n}  \\

\end{bmatrix}
$$

### 优化：

##### 部分隐式离散

毫无疑问，每次步进计算一个新的数据$U^{n + 1}$，要求解一个$G(U) = 0$, 假设牛顿迭代需要10次，那就需要求解10次$J \Delta U = G$， 每一次都要计算一个$J和G$，假设$U$ 有3个元素，一个$J$就要计算3次扰动 $U$之后的$R$向量， 一个G又需要算一次$R$向量，合计就是一次步进要计算40次$R$；

前面的描述中$R = -F_x + S$中的全部项都采用隐式离散，那如果$F_x$采用显式离散，$S$采用隐式离散，$R$的复杂程度大大减弱，就不需要再每次隐式计算中反复重新对$F$进行插值差分和通量差分分裂

过程整理如下：
$$
\frac{\partial U}{\partial t} + \frac{\partial F}{\partial x} = S(U)
$$
只隐式离散源项：
$$
U^{n+1} - U^{n} = \Delta t(-\frac{\partial F(U^{n})}{\partial x} + S(U^{n+1})) \\
U^{n+1} - U^{n} = \Delta t(R(U^{n+1})) \\
G(U^{n+1}) = U^{n+1} - U^n - \Delta t R(U^{n+1}) = 0 \\
$$
其中: $R(U^{n+1}) = -\frac{\partial F(U^{n})}{\partial x} + S(U^{n+1})$

后续的牛顿迭代和雅可比计算方法都是针对新的$R(U)$来处理的,对流项采用显式离散之后，对流导数项成为已知常数，计算R的雅可比等同计算S的雅可比:
$$
J_R^{ij} = \frac{\partial R_i}{\partial U_j} = \frac{R_i(U+\epsilon e_j) - R_i(U)}{\epsilon} = \frac{S_i(U+\epsilon e_j) - S_i(U)}{\epsilon}
$$


##### 牛顿阻尼

在牛顿迭代过程中，通过加入阻尼主动减缓更新的步长，这对于强非线性，强刚性问题非常有效，能够很好地防止解不收敛地情况，尤其是针对出现负质量分数的情况，能够很好的保证解的物理可行性；

两种阻尼方法是非常合适好的：

**物理约束驱动阻尼**：当某些物理量为负数的时候，缩短迭代步长，直至步长不会过长导致违反物理约束；

**相对变化阻尼**：控制最大的阻尼系数为C，同时依据残差来动态变化阻尼系数，残差越大，阻尼系数越小，步进越谨慎，残差越小，阻尼系数越大，步进越放松

```
error = max(|dU| / (|U| + eps))
alpha = min(1.0, C / error)
```

